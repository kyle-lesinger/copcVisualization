(function webpackUniversalModuleDefinition(root, factory) {
  if (typeof exports === 'object' && typeof module === 'object')
    module.exports = factory();
  else if (typeof define === 'function' && define.amd) define([], factory);
        else if (typeof exports === 'object') exports['deck'] = factory();
  else root['deck'] = factory();})(globalThis, function () {
"use strict";var __exports__=(()=>{var st=Object.create;var C=Object.defineProperty;var at=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var lt=Object.getPrototypeOf,pt=Object.prototype.hasOwnProperty;var ut=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),dt=(e,t)=>{for(var o in t)C(e,o,{get:t[o],enumerable:!0})},S=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ct(t))!pt.call(e,r)&&r!==o&&C(e,r,{get:()=>t[r],enumerable:!(n=at(t,r))||n.enumerable});return e},h=(e,t,o)=>(S(e,t,"default"),o&&S(o,t,"default")),v=(e,t,o)=>(o=e!=null?st(lt(e)):{},S(t||!e||!e.__esModule?C(o,"default",{value:e,enumerable:!0}):o,e)),ht=e=>S(C({},"__esModule",{value:!0}),e);var f=ut((Rt,W)=>{W.exports=globalThis.deck});var T={};dt(T,{MapboxOverlay:()=>k});var u={},H=v(f(),1);h(u,v(f(),1));if(!H.Layer)throw new Error("@deck.gl/core is not found");h(T,u);var M=v(f(),1);var d=v(f(),1);function O(e,t){if(!e)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}var m=Math.PI,gt=m/4,V=m/180,Ut=180/m,A=512,yt=4003e4;function b(e){let[t,o]=e;O(Number.isFinite(t)),O(Number.isFinite(o)&&o>=-90&&o<=90,"invalid latitude");let n=t*V,r=o*V,a=A*(n+m)/(2*m),i=A*(m+Math.log(Math.tan(gt+r*.5)))/(2*m);return[a,i]}function Z(e){let t=Math.cos(e*V);return A/yt/t}var $t=Math.PI/180;var L="mapbox",N=512,It=Math.PI/180;function F({map:e,gl:t,deck:o}){if(e.__deck)return e.__deck;let n=o?.props._customRender,r=o?.props.onLoad,a={...o?.props,_customRender:()=>{e.triggerRepaint(),n?.("")}};a.parameters={...P(e,!0),...a.parameters},a.views||=x(e);let i;return(!o||o.props.gl===t)&&(Object.assign(a,{gl:t,width:null,height:null,touchAction:"unset",viewState:_(e)}),o?.isInitialized?J(o,e):a.onLoad=()=>{r?.(),J(i,e)}),o?(i=o,o.setProps(a),o.userData.isExternal=!0):(i=new d.Deck(a),e.on("remove",()=>{U(e)})),i.userData.mapboxLayers=new Set,e.__deck=i,e.on("render",()=>{i.isInitialized&&Ct(i,e)}),i}function J(e,t){let o=()=>{e.isInitialized?Ot(e,t):t.off("move",o)};t.on("move",o)}function U(e){e.__deck?.finalize(),e.__deck=null}function P(e,t){let o=t?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return R(e)==="globe"&&(o.cullMode="back"),o}function K(e,t){e.userData.mapboxLayers.add(t),X(e)}function Q(e,t){e.userData.mapboxLayers.delete(t),X(e)}function tt(e,t){X(e)}function et(e,t,o,n){let{currentViewport:r}=e.userData,a=!1;r||(r=ot(e,t,n),e.userData.currentViewport=r,a=!0),e.isInitialized&&e._drawLayers("mapbox-repaint",{viewports:[r],layerFilter:i=>(!e.props.layerFilter||e.props.layerFilter(i))&&(o.id===i.layer.id||i.layer.props.operation.includes("terrain")),clearStack:a,clearCanvas:!1})}function R(e){let t=e.getProjection?.(),o=t?.type||t?.name;if(o==="globe")return"globe";if(o&&o!=="mercator")throw new Error("Unsupported projection");return"mercator"}function x(e){return R(e)==="globe"?new d._GlobeView({id:L}):new d.MapView({id:L})}function _(e){let{lng:t,lat:o}=e.getCenter(),n={longitude:(t+540)%360-180,latitude:o,zoom:e.getZoom(),bearing:e.getBearing(),pitch:e.getPitch(),padding:e.getPadding(),repeat:e.getRenderWorldCopies()};return e.getTerrain?.()&&St(e,n),n}function St(e,t){if(e.getFreeCameraOptions){let{position:o}=e.getFreeCameraOptions();if(!o||o.z===void 0)return;let n=e.transform.height,{longitude:r,latitude:a,pitch:i}=t,s=o.x*N,c=(1-o.y)*N,l=o.z*N,p=b([r,a]),g=s-p[0],y=c-p[1],j=Math.sqrt(g*g+y*y),I=i*It,z=1.5*n,Y=I<.001?z*Math.cos(I)/l:z*Math.sin(I)/j;t.zoom=Math.log2(Y);let rt=z*Math.cos(I)/Y,it=l-rt;t.position=[0,0,it/Z(a)]}else typeof e.transform.elevation=="number"&&(t.position=[0,0,e.transform.elevation])}function ot(e,t,o){let n=_(t),{views:r}=e.props,a=r&&(0,d._flatten)(r).find(c=>c.id===L)||x(t);o&&(a.props.nearZMultiplier=.2);let i=o?.nearZ??t.transform._nearZ,s=o?.farZ??t.transform._farZ;return Number.isFinite(i)&&(n.nearZ=i/t.transform.height,n.farZ=s/t.transform.height),a.makeViewport({width:e.width,height:e.height,viewState:n})}function Ct(e,t){let{mapboxLayers:o,isExternal:n}=e.userData;if(n){let r=Array.from(o,p=>p.id),i=(0,d._flatten)(e.props.layers,Boolean).some(p=>p&&!r.includes(p.id)),s=e.getViewports(),c=s.findIndex(p=>p.id===L),l=s.length>1||c<0;(i||l)&&(c>=0&&(s=s.slice(),s[c]=ot(e,t)),e._drawLayers("mapbox-repaint",{viewports:s,layerFilter:p=>(!e.props.layerFilter||e.props.layerFilter(p))&&(p.viewport.id!==L||!r.includes(p.layer.id)),clearCanvas:!1}))}e.userData.currentViewport=null}function Ot(e,t){e.setProps({viewState:_(t)}),e.needsRedraw({clearRedrawFlags:!0})}function X(e){if(e.userData.isExternal)return;let t=[];e.userData.mapboxLayers.forEach(o=>{let n=o.props.type,r=new n(o.props);t.push(r)}),e.setProps({layers:t})}var nt=v(f(),1);var B=v(f(),1);var D=class{constructor(t){if(!t.id)throw new Error("Layer must have an unique id");this.id=t.id,this.type="custom",this.renderingMode=t.renderingMode||"3d",this.slot=t.slot,this.map=null,this.deck=null,this.props=t}onAdd(t,o){this.map=t,this.deck=F({map:t,gl:o,deck:this.props.deck}),K(this.deck,this)}onRemove(){this.deck&&Q(this.deck,this)}setProps(t){Object.assign(this.props,t,{id:this.id}),this.deck&&tt(this.deck,this)}render(t,o){et(this.deck,this.map,this,o)}};var G="__UNDEFINED__";function E(e,t,o,n){if(!e||!t||!e.style||!e.style._loaded)return;let r=(0,B._flatten)(n,Boolean);if(o!==n){let s=(0,B._flatten)(o,Boolean),c=new Set(s.map(l=>l.id));for(let l of r)c.delete(l.id);for(let l of c)e.getLayer(l)&&e.removeLayer(l)}for(let s of r){let c=e.getLayer(s.id);c?(c.implementation||c).setProps(s.props):e.addLayer(new D({id:s.id,deck:t,slot:s.props.slot}),s.props.beforeId)}let a=e.style._order,i={};for(let s of r){let{beforeId:c}=s.props;(!c||!a.includes(c))&&(c=G),i[c]=i[c]||[],i[c].push(s.id)}for(let s in i){let c=i[s],l=s===G?a.length:a.indexOf(s),p=s===G?void 0:s;for(let g=c.length-1;g>=0;g--){let y=c[g],j=a.indexOf(y);j!==l-1&&(e.moveLayer(y,p),j>l&&l++),l--,p=y}}}var k=class{constructor(t){this._handleStyleChange=()=>{if(E(this._map,this._deck,this._props.layers,this._props.layers),!this._map)return;R(this._map)&&!this._props.views&&this._deck?.setProps({views:x(this._map)})};this._updateContainerSize=()=>{if(this._map&&this._container){let{clientWidth:t,clientHeight:o}=this._map.getContainer();Object.assign(this._container.style,{width:`${t}px`,height:`${o}px`})}};this._updateViewState=()=>{let t=this._deck,o=this._map;t&&o&&(t.setProps({views:this._props.views||x(o),viewState:_(o)}),t.isInitialized&&t.redraw())};this._handleMouseEvent=t=>{let o=this._deck;if(!o||!o.isInitialized)return;let n={type:t.type,offsetCenter:t.point,srcEvent:t},r=this._lastMouseDownPoint;switch(!t.point&&r&&(n.deltaX=t.originalEvent.clientX-r.clientX,n.deltaY=t.originalEvent.clientY-r.clientY,n.offsetCenter={x:r.x+n.deltaX,y:r.y+n.deltaY}),n.type){case"mousedown":o._onPointerDown(n),this._lastMouseDownPoint={...t.point,clientX:t.originalEvent.clientX,clientY:t.originalEvent.clientY};break;case"dragstart":n.type="panstart",o._onEvent(n);break;case"drag":n.type="panmove",o._onEvent(n);break;case"dragend":n.type="panend",o._onEvent(n);break;case"click":n.tapCount=1,o._onEvent(n);break;case"dblclick":n.type="click",n.tapCount=2,o._onEvent(n);break;case"mousemove":n.type="pointermove",o._onPointerMove(n);break;case"mouseout":n.type="pointerleave",o._onPointerMove(n);break;default:return}};let{interleaved:o=!1}=t;this._interleaved=o,this._props=this.filterProps(t)}filterProps(t){let{interleaved:o=!1,useDevicePixels:n,...r}=t;return!o&&n!==void 0&&(r.useDevicePixels=n),r}setProps(t){this._interleaved&&t.layers&&E(this._map,this._deck,this._props.layers,t.layers),Object.assign(this._props,this.filterProps(t)),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...P(this._map,this._interleaved),...this._props.parameters}})}onAdd(t){return this._map=t,this._interleaved?this._onAddInterleaved(t):this._onAddOverlaid(t)}_onAddOverlaid(t){let o=document.createElement("div");return Object.assign(o.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=o,this._deck=new M.Deck({...this._props,parent:o,parameters:{...P(t,!1),...this._props.parameters},views:this._props.views||x(t),viewState:_(t)}),t.on("resize",this._updateContainerSize),t.on("render",this._updateViewState),t.on("mousedown",this._handleMouseEvent),t.on("dragstart",this._handleMouseEvent),t.on("drag",this._handleMouseEvent),t.on("dragend",this._handleMouseEvent),t.on("mousemove",this._handleMouseEvent),t.on("mouseout",this._handleMouseEvent),t.on("click",this._handleMouseEvent),t.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),o}_onAddInterleaved(t){let o=t.painter.context.gl;return o instanceof WebGLRenderingContext&&nt.log.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=F({map:t,gl:o,deck:new M.Deck({...this._props,gl:o,parameters:{...P(t,!1),...this._props.parameters},deviceProps:{createCanvasContext:{autoResize:!0}}})}),t.on("styledata",this._handleStyleChange),E(t,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){let t=this._map;t&&(this._interleaved?this._onRemoveInterleaved(t):this._onRemoveOverlaid(t)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(t){t.off("resize",this._updateContainerSize),t.off("render",this._updateViewState),t.off("mousedown",this._handleMouseEvent),t.off("dragstart",this._handleMouseEvent),t.off("drag",this._handleMouseEvent),t.off("dragend",this._handleMouseEvent),t.off("mousemove",this._handleMouseEvent),t.off("mouseout",this._handleMouseEvent),t.off("click",this._handleMouseEvent),t.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(t){t.off("styledata",this._handleStyleChange),E(t,this._deck,this._props.layers,[]),U(t)}getDefaultPosition(){return"top-left"}pickObject(t){return(0,M.assert)(this._deck),this._deck.pickObject(t)}pickMultipleObjects(t){return(0,M.assert)(this._deck),this._deck.pickMultipleObjects(t)}pickObjects(t){return(0,M.assert)(this._deck),this._deck.pickObjects(t)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}};return ht(T);})();
      return __exports__;
      });
